<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard E-Katalog Sumber Daya Air</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
        }
        .leaflet-container {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
        }
        .info-panel {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info-panel h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-weight: 600;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }
        /* Microsoft-style scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* Custom class to ensure modals are on top */
        .modal-container {
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg flex flex-col">
            <div class="p-4 border-b">
                <h1 class="text-xl font-bold text-gray-700">E-Katalog SDA</h1>
                <p class="text-xs text-gray-500">Dashboard Monitoring</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center p-2 text-base font-normal text-gray-900 rounded-lg bg-gray-200">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="#" onclick="openModal('marketSoundingModal')" class="flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="ml-3">Input Market Sounding</span>
                </a>
                 <a href="#" onclick="openModal('historyModal')" class="flex items-center p-2 text-base font-normal text-gray-900 rounded-lg hover:bg-gray-100">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="ml-3">Histori Market Sounding</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-y-auto">
            <header class="mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Dashboard Analitik Produk</h2>
                <!-- Analysis Section -->
                <div class="mt-2 p-4 bg-white rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Analisis Market Sounding</h3>
                    <!-- Comparison Controls -->
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <div class="flex-1">
                            <label for="comparisonDate" class="block text-sm font-medium text-gray-700">Pilih Event Market Sounding</label>
                            <select id="comparisonDate" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="latest">Tampilkan Data Terkini</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="comparisonDay" class="block text-sm font-medium text-gray-700">Bandingkan dengan (hari setelahnya)</label>
                            <input type="number" id="comparisonDay" value="30" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        </div>
                         <button onclick="runComparison()" class="w-full md:w-auto mt-4 md:mt-0 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Jalankan Analisis</button>
                    </div>
                </div>
                <!-- Filters -->
                <div class="mt-4 p-4 bg-white rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="filterProvinsi" class="block text-sm font-medium text-gray-700">Provinsi</label>
                            <select id="filterProvinsi" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">Semua Provinsi</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterKategori1" class="block text-sm font-medium text-gray-700">Kategori 1</label>
                            <select id="filterKategori1" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">Semua Kategori 1</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterKategori2" class="block text-sm font-medium text-gray-700">Kategori 2</label>
                            <select id="filterKategori2" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">Semua Kategori 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterProduk" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                            <select id="filterProduk" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="all">Semua Produk</option>
                            </select>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Stats Cards -->
            <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Cards will be injected by JS -->
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Map -->
                <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow h-[60vh] overflow-hidden">
                    <h3 class="font-semibold mb-2">Persebaran Produk di Indonesia</h3>
                    <div id="map" class="h-full w-full"></div>
                </div>
                <!-- Charts -->
                <div class="bg-white p-4 rounded-lg shadow h-[60vh]">
                    <h3 class="font-semibold mb-2">Produk per Kategori</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Filtered Results Table -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-semibold mb-2">Detail Produk</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perusahaan</th>
                            </tr>
                        </thead>
                        <tbody id="filteredTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <!-- Market Sounding Input Modal -->
    <div id="marketSoundingModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center" onclick="closeModalOnOutsideClick(event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6" id="modal-content-ms">
            <h2 class="text-xl font-bold mb-4">Catat Market Sounding</h2>
            <form id="marketSoundingForm">
                <div class="mb-4">
                    <label for="balai" class="block text-sm font-medium text-gray-700">Balai yang Mengajukan</label>
                    <input type="text" id="balai" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="provinsi" class="block text-sm font-medium text-gray-700">Wilayah (Provinsi)</label>
                    <select id="provinsi" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                       <!-- Options will be populated by JS -->
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="paket_pekerjaan" class="block text-sm font-medium text-gray-700">Paket Pekerjaan</label>
                    <input type="text" id="paket_pekerjaan" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal Market Sounding</label>
                    <input type="date" id="tanggal" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('marketSoundingModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center" onclick="closeModalOnOutsideClick(event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6" id="modal-content-hist">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Histori Market Sounding</h2>
                 <button type="button" onclick="closeModal('historyModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
            </div>
            <div class="overflow-y-auto max-h-[70vh]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balai</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wilayah</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paket Pekerjaan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Perubahan Produk</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analysis Result Modal -->
    <div id="analysisResultModal" class="modal-container fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center" onclick="closeModalOnOutsideClick(event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6" id="modal-content-analysis">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Hasil Perbandingan Market Sounding</h2>
                 <button type="button" onclick="closeModal('analysisResultModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
            </div>
            <div id="comparison-content" class="overflow-y-auto max-h-[70vh]">
                <!-- Analysis content will be injected by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- MOCK DATA ---
        const NAMA_PROVINSI = ['ACEH', 'SUMATERA UTARA', 'SUMATERA BARAT', 'RIAU', 'JAMBI', 'SUMATERA SELATAN', 'BENGKULU', 'LAMPUNG', 'KEPULAUAN BANGKA BELITUNG', 'KEPULAUAN RIAU', 'DKI JAKARTA', 'JAWA BARAT', 'JAWA TENGAH', 'DAERAH ISTIMEWA YOGYAKARTA', 'JAWA TIMUR', 'BANTEN', 'BALI', 'NUSA TENGGARA BARAT', 'NUSA TENGGARA TIMUR', 'KALIMANTAN BARAT', 'KALIMANTAN TENGAH', 'KALIMANTAN SELATAN', 'KALIMANTAN TIMUR', 'KALIMANTAN UTARA', 'SULAWESI UTARA', 'SULAWESI TENGAH', 'SULAWESI SELATAN', 'SULAWESI TENGGARA', 'GORONTALO', 'SULAWESI BARAT', 'MALUKU', 'MALUKU UTARA', 'PAPUA BARAT', 'PAPUA', 'PAPUA TENGAH', 'PAPUA PEGUNUNGAN', 'PAPUA SELATAN', 'PAPUA BARAT DAYA'];

        const dataSnapshots = {
            '2025-06-01': [
                { kategori_1: 'Konstruksi', kategori_2: 'Bendungan', nama_produk: 'Pintu Air Tipe A', harga: 120000000, provinsi: 'JAWA BARAT', perusahaan: 'PT Karya Baja', last_update: '2025-05-20' },
                { kategori_1: 'Peralatan', kategori_2: 'Pompa', nama_produk: 'Pompa Submersible 5HP', harga: 75000000, provinsi: 'JAWA TIMUR', perusahaan: 'PT Pompa Jaya', last_update: '2025-05-15' },
                { kategori_1: 'Konstruksi', kategori_2: 'Irigasi', nama_produk: 'Pipa HDPE 12 inch', harga: 350000, provinsi: 'SULAWESI SELATAN', perusahaan: 'PT Pipa Kuat', last_update: '2025-05-22' },
            ],
            '2025-08-15': [
                { kategori_1: 'Konstruksi', kategori_2: 'Bendungan', nama_produk: 'Pintu Air Tipe A', harga: 120000000, provinsi: 'JAWA BARAT', perusahaan: 'PT Karya Baja', last_update: '2025-05-20' },
                { kategori_1: 'Konstruksi', kategori_2: 'Bendungan', nama_produk: 'Pintu Air Tipe B (Baru)', harga: 150000000, provinsi: 'JAWA BARAT', perusahaan: 'PT Karya Baja', last_update: '2025-08-10' },
                { kategori_1: 'Peralatan', kategori_2: 'Pompa', nama_produk: 'Pompa Submersible 5HP', harga: 72000000, provinsi: 'JAWA TIMUR', perusahaan: 'PT Pompa Jaya', last_update: '2025-08-01' },
                { kategori_1: 'Konstruksi', kategori_2: 'Irigasi', nama_produk: 'Pipa HDPE 12 inch', harga: 350000, provinsi: 'SULAWESI SELATAN', perusahaan: 'PT Pipa Kuat', last_update: '2025-05-22' },
                { kategori_1: 'Jasa', kategori_2: 'Konsultansi', nama_produk: 'Studi Kelayakan Bendungan', harga: 500000000, provinsi: 'DKI JAKARTA', perusahaan: 'CV Cipta Konsul', last_update: '2025-07-30' },
            ]
        };

        let marketSoundingLog = [
            { tanggal: '2025-06-01', balai: 'BBWS Citarum', wilayah: 'JAWA BARAT', paket_pekerjaan: 'Pembangunan Bendungan Ciawi', totalPerubahan: 2 },
            { tanggal: '2025-08-15', balai: 'BBWS Brantas', wilayah: 'JAWA TIMUR', paket_pekerjaan: 'Modernisasi Irigasi Brantas', totalPerubahan: 3 }
        ];

        let latestProducts = [
            ...dataSnapshots['2025-08-15'],
            { kategori_1: 'Peralatan', kategori_2: 'Sensor', nama_produk: 'Sensor Ketinggian Air', harga: 25000000, provinsi: 'KALIMANTAN TIMUR', perusahaan: 'PT Sensorindo', last_update: '2025-09-01' },
            { kategori_1: 'Konstruksi', kategori_2: 'Irigasi', nama_produk: 'Box Tersier', harga: 1200000, provinsi: 'JAWA TENGAH', perusahaan: 'PT Beton Presisi', last_update: '2025-09-05' },
        ];

        let activeDataSource = latestProducts; // Data source that is currently being displayed

        // --- GEOJSON DATA ---
        const indonesiaGeoJson = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "properties": { "name": "ACEH" }, "geometry": { "type": "Point", "coordinates": [96.92, 4.22] } },
                { "type": "Feature", "properties": { "name": "SUMATERA UTARA" }, "geometry": { "type": "Point", "coordinates": [99.5, 2.5] } },
                { "type": "Feature", "properties": { "name": "JAWA BARAT" }, "geometry": { "type": "Point", "coordinates": [107.6, -6.9] } },
                { "type": "Feature", "properties": { "name": "JAWA TIMUR" }, "geometry": { "type": "Point", "coordinates": [112.7, -7.5] } },
                { "type": "Feature", "properties": { "name": "SULAWESI SELATAN" }, "geometry": { "type": "Point", "coordinates": [120, -4] } },
                { "type": "Feature", "properties": { "name": "KALIMANTAN TIMUR" }, "geometry": { "type": "Point", "coordinates": [116.4, 0.5] } },
                { "type": "Feature", "properties": { "name": "DKI JAKARTA" }, "geometry": { "type": "Point", "coordinates": [106.8, -6.2] } },
                 { "type": "Feature", "properties": { "name": "JAWA TENGAH" }, "geometry": { "type": "Point", "coordinates": [110.2, -7.2] } },
                 { "type": "Feature", "properties": { "name": "PAPUA" }, "geometry": { "type": "Point", "coordinates": [138, -4.5] } }
            ]
        };

        // --- MAP INITIALIZATION ---
        let map; // Declare map variable

        function initMap() {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([-2.5, 118], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            infoPanel.addTo(map);
            legend.addTo(map);
        }

        let geojsonLayer;
        let infoPanel = L.control();
        let legend = L.control({position: 'bottomright'});
        
        infoPanel.onAdd = function (map) { this._div = L.DomUtil.create('div', 'info-panel'); this.update(); return this._div; };
        infoPanel.update = function (props) { this._div.innerHTML = '<h4>Jumlah Produk per Provinsi</h4>' + (props ? '<b>' + props.name + '</b><br />' + (props.density || 0) + ' produk' : 'Arahkan mouse ke provinsi'); };

        legend.onAdd = function (map) {
            let div = L.DomUtil.create('div', 'info-panel legend'), grades = [0, 1, 2, 5, 10];
            for (let i = 0; i < grades.length; i++) { div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' + grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+'); }
            return div;
        };
        
        // --- CHART INITIALIZATION ---
        const ctx = document.getElementById('categoryChart').getContext('2d');
        let categoryChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Jumlah Produk', data: [], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });

        // --- CORE FUNCTIONS ---
        function updateDashboard(productData) {
            // Update Stats
            const totalProducts = productData.length;
            const categories = [...new Set(productData.map(p => p.kategori_1))].length;
            
            document.getElementById('stats-cards').innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-sm font-semibold text-gray-500">Total Produk Tampil</h4>
                    <p class="text-3xl font-bold">${totalProducts.toLocaleString('id-ID')}</p>
                </div>
                 <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-sm font-semibold text-gray-500">Jumlah Kategori Unik</h4>
                    <p class="text-3xl font-bold">${categories}</p>
                </div>
            `;

            // Update Map
            if (map) {
                const productCountByProvince = productData.reduce((acc, product) => { acc[product.provinsi] = (acc[product.provinsi] || 0) + 1; return acc; }, {});
                if (geojsonLayer) { map.removeLayer(geojsonLayer); }
                geojsonLayer = L.geoJson(indonesiaGeoJson, {
                    style: feature => { const count = productCountByProvince[feature.properties.name] || 0; return { fillColor: getColor(count), weight: 1, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7, radius: 5 + count * 2, color: "#333" }; },
                    onEachFeature: (feature, layer) => {
                        layer.on({
                            mouseover: e => { let layer = e.target; layer.setStyle({ weight: 3, color: '#666', dashArray: '', }); infoPanel.update(layer.feature.properties); },
                            mouseout: e => { geojsonLayer.resetStyle(e.target); infoPanel.update(); }
                        });
                         if (feature.geometry.type === 'Point') { const count = productCountByProvince[feature.properties.name] || 0; layer.setRadius(5 + count * 2); layer.bindPopup(`<b>${feature.properties.name}</b><br>${count} produk`); }
                    },
                    pointToLayer: (feature, latlng) => L.circleMarker(latlng)
                }).addTo(map);
                geojsonLayer.eachLayer(layer => { const provName = layer.feature.properties.name; layer.feature.properties.density = productCountByProvince[provName] || 0; });
                map.invalidateSize();
            }

            // Update Chart
            const productCountByCategory = productData.reduce((acc, product) => { acc[product.kategori_1] = (acc[product.kategori_1] || 0) + 1; return acc; }, {});
            categoryChart.data.labels = Object.keys(productCountByCategory);
            categoryChart.data.datasets[0].data = Object.values(productCountByCategory);
            categoryChart.update();
        }

        function updateFilteredTable(productData) {
            const tableBody = document.getElementById('filteredTableBody');
            tableBody.innerHTML = '';
            if (productData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-gray-500">Tidak ada data yang cocok dengan filter.</td></tr>`;
                return;
            }
            productData.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.nama_produk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.perusahaan}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function getColor(d) { return d > 10 ? '#800026' : d > 5 ? '#BD0026' : d > 2 ? '#E31A1C' : d > 1 ? '#FC4E2A' : d > 0 ? '#FED976' : '#d1d5db'; }

        function runComparison() {
            const selectedDate = document.getElementById('comparisonDate').value;
            
            if (selectedDate === 'latest') {
                 activeDataSource = latestProducts;
                 populateFilters(activeDataSource, true);
                 applyAndRenderFilters();
                 return;
            }
            
            const comparisonDays = parseInt(document.getElementById('comparisonDay').value);
            const dataBefore = dataSnapshots[selectedDate];
            const dateAfter = new Date(selectedDate);
            dateAfter.setDate(dateAfter.getDate() + comparisonDays);
            const dataAfter = latestProducts.filter(p => new Date(p.last_update) <= dateAfter);
            
            const selectedLog = marketSoundingLog.find(log => log.tanggal === selectedDate);
            const contentDiv = document.getElementById('comparison-content');
            const productsBeforeNames = new Set(dataBefore.map(p => p.nama_produk));
            const productsAfterNames = new Set(dataAfter.map(p => p.nama_produk));
            const newProducts = [...productsAfterNames].filter(p => !productsBeforeNames.has(p));
            const removedProducts = [...productsBeforeNames].filter(p => !productsAfterNames.has(p));

            contentDiv.innerHTML = `
                <div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg mb-4">
                    <p class="font-semibold text-blue-800">Analisis untuk Market Sounding oleh ${selectedLog.balai}</p>
                    <p class="text-sm text-gray-700">Paket Pekerjaan: <span class="font-medium">"${selectedLog.paket_pekerjaan}"</span></p>
                </div>
                <p class="mb-2">Perbandingan data pada <strong>${selectedDate}</strong> dengan <strong>${comparisonDays} hari setelahnya</strong>.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-semibold">Produk Awal</h4><p class="text-2xl">${dataBefore.length}</p></div>
                    <div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-semibold">Produk Akhir</h4><p class="text-2xl">${dataAfter.length}</p></div>
                    <div class="p-4 rounded-lg ${dataAfter.length > dataBefore.length ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}"><h4 class="font-semibold">Perubahan</h4><p class="text-2xl">${dataAfter.length - dataBefore.length > 0 ? '+' : ''}${dataAfter.length - dataBefore.length}</p></div>
                </div>
                <div class="mt-4"><h4 class="font-semibold">Produk Baru:</h4><ul class="list-disc pl-5 text-sm text-green-700">${newProducts.length > 0 ? newProducts.map(p => `<li>${p}</li>`).join('') : '<li>Tidak ada.</li>'}</ul></div>
                <div class="mt-2"><h4 class="font-semibold">Produk Dihapus/Diganti:</h4><ul class="list-disc pl-5 text-sm text-red-700">${removedProducts.length > 0 ? removedProducts.map(p => `<li>${p}</li>`).join('') : '<li>Tidak ada.</li>'}</ul></div>`;
            
            openModal('analysisResultModal');
        }

        // --- FILTER LOGIC ---
        const filters = {
            provinsi: document.getElementById('filterProvinsi'),
            kategori1: document.getElementById('filterKategori1'),
            kategori2: document.getElementById('filterKategori2'),
            produk: document.getElementById('filterProduk')
        };
        
        function populateSelect(selectElement, options, defaultValue) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = `<option value="all">${defaultValue}</option>`;
            [...new Set(options)].sort().forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            selectElement.value = currentValue && options.includes(currentValue) ? currentValue : 'all';
        }

        function populateFilters(data, resetAll = false) {
            if (resetAll) {
                Object.values(filters).forEach(sel => sel.value = 'all');
            }
            
            let filteredData = [...data];
            
            populateSelect(filters.provinsi, data.map(p => p.provinsi), 'Semua Provinsi');
            if (filters.provinsi.value !== 'all') {
                filteredData = filteredData.filter(p => p.provinsi === filters.provinsi.value);
            }

            populateSelect(filters.kategori1, filteredData.map(p => p.kategori_1), 'Semua Kategori 1');
            if (filters.kategori1.value !== 'all') {
                filteredData = filteredData.filter(p => p.kategori_1 === filters.kategori1.value);
            }

            populateSelect(filters.kategori2, filteredData.map(p => p.kategori_2).filter(Boolean), 'Semua Kategori 2');
            if (filters.kategori2.value !== 'all') {
                filteredData = filteredData.filter(p => p.kategori_2 === filters.kategori2.value);
            }

            populateSelect(filters.produk, filteredData.map(p => p.nama_produk), 'Semua Produk');
        }

        function applyAndRenderFilters() {
            let dataToRender = [...activeDataSource];
            if (filters.provinsi.value !== 'all') dataToRender = dataToRender.filter(p => p.provinsi === filters.provinsi.value);
            if (filters.kategori1.value !== 'all') dataToRender = dataToRender.filter(p => p.kategori_1 === filters.kategori1.value);
            if (filters.kategori2.value !== 'all') dataToRender = dataToRender.filter(p => p.kategori_2 === filters.kategori2.value);
            if (filters.produk.value !== 'all') dataToRender = dataToRender.filter(p => p.nama_produk === filters.produk.value);
            
            updateDashboard(dataToRender);
            updateFilteredTable(dataToRender);
        }

        Object.values(filters).forEach(select => {
            select.addEventListener('change', () => {
                populateFilters(activeDataSource);
                applyAndRenderFilters();
            });
        });

        // --- MODAL CONTROLS ---
        function openModal(modalId) { 
            document.getElementById(modalId).style.display = 'flex'; 
            if (modalId !== 'analysisResultModal' && map) {
                setTimeout(() => map.invalidateSize(), 1);
            }
        }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function closeModalOnOutsideClick(event) { if (event.target.classList.contains('modal-container')) { closeModal(event.target.id); } }

        function handleComparisonChange() {
            const comparisonSelect = document.getElementById('comparisonDate');
            if (comparisonSelect.value === 'latest') {
                // If 'Tampilkan Data Terkini' is selected, reset the view immediately.
                activeDataSource = latestProducts;
                populateFilters(activeDataSource, true);
                applyAndRenderFilters();
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            
            const comparisonSelect = document.getElementById('comparisonDate');
            marketSoundingLog.forEach(log => {
                const option = document.createElement('option');
                option.value = log.tanggal;
                option.textContent = `${log.balai}: ${log.paket_pekerjaan}`;
                comparisonSelect.appendChild(option);
            });
            comparisonSelect.addEventListener('change', handleComparisonChange);

            const provinsiSelect = document.getElementById('provinsi');
            NAMA_PROVINSI.forEach(prov => { const option = document.createElement('option'); option.value = prov; option.textContent = prov; provinsiSelect.appendChild(option); });

            const historyBody = document.getElementById('historyTableBody');
            marketSoundingLog.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.tanggal}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.balai}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.wilayah}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.paket_pekerjaan}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${log.totalPerubahan > 0 ? 'text-green-600' : 'text-gray-500'}">
                       ${log.totalPerubahan > 0 ? `+${log.totalPerubahan} produk` : 'Tidak ada perubahan'}
                    </td>
                `;
                historyBody.appendChild(row);
            });

            document.getElementById('marketSoundingForm').addEventListener('submit', function(e) { e.preventDefault(); alert('Data Market Sounding berhasil disimulasikan!'); closeModal('marketSoundingModal'); this.reset(); });

            populateFilters(activeDataSource, true);
            applyAndRenderFilters();
        });
    </script>
</body>
</html>

